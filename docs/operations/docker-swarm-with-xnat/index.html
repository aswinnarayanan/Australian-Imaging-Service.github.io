<!doctype html><html lang=en class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.88.1"><meta name=ROBOTS content="NOINDEX, NOFOLLOW">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>Docker-Swarm-with-XNAT | Australian Imaging Service</title>
<meta name=description content><meta property="og:title" content="Docker-Swarm-with-XNAT">
<meta property="og:description" content="Setting up Docker Swarm A complete explanation of how to setup Docker Swarm is outside the scope of this document but you can find some useful articles here:
https://scalified.com/2018/10/08/building-jenkins-pipelines-docker-swarm/
https://docs.docker.com/engine/swarm/swarm-tutorial/create-swarm/
https://docs.docker.com/engine/swarm/ingress/
Setting up with AWS:
https://semaphoreci.com/community/tutorials/bootstrapping-a-docker-swarm-mode-cluster
Pipelines XNAT uses pipelines to perform various different processes - mostly converting image types to other image types (DICOM to NIFTI for example).
In the past this was handled on the instance as part of the XNAT program, then as a docker server on the instance and finally, externally as an external docker server, either directly or using Docker swarm.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://australian-imaging-service.github.io/docs/operations/docker-swarm-with-xnat/"><meta property="article:section" content="docs">
<meta itemprop=name content="Docker-Swarm-with-XNAT">
<meta itemprop=description content="Setting up Docker Swarm A complete explanation of how to setup Docker Swarm is outside the scope of this document but you can find some useful articles here:
https://scalified.com/2018/10/08/building-jenkins-pipelines-docker-swarm/
https://docs.docker.com/engine/swarm/swarm-tutorial/create-swarm/
https://docs.docker.com/engine/swarm/ingress/
Setting up with AWS:
https://semaphoreci.com/community/tutorials/bootstrapping-a-docker-swarm-mode-cluster
Pipelines XNAT uses pipelines to perform various different processes - mostly converting image types to other image types (DICOM to NIFTI for example).
In the past this was handled on the instance as part of the XNAT program, then as a docker server on the instance and finally, externally as an external docker server, either directly or using Docker swarm.">
<meta itemprop=wordCount content="1444">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="Docker-Swarm-with-XNAT">
<meta name=twitter:description content="Setting up Docker Swarm A complete explanation of how to setup Docker Swarm is outside the scope of this document but you can find some useful articles here:
https://scalified.com/2018/10/08/building-jenkins-pipelines-docker-swarm/
https://docs.docker.com/engine/swarm/swarm-tutorial/create-swarm/
https://docs.docker.com/engine/swarm/ingress/
Setting up with AWS:
https://semaphoreci.com/community/tutorials/bootstrapping-a-docker-swarm-mode-cluster
Pipelines XNAT uses pipelines to perform various different processes - mostly converting image types to other image types (DICOM to NIFTI for example).
In the past this was handled on the instance as part of the XNAT program, then as a docker server on the instance and finally, externally as an external docker server, either directly or using Docker swarm.">
<link rel=preload href=/scss/main.min.a297386ca48b17e0c043ee28776ce3a30b14c8baadd081e294f064fac523b4f4.css as=style>
<link href=/scss/main.min.a297386ca48b17e0c043ee28776ce3a30b14c8baadd081e294f064fac523b4f4.css rel=stylesheet integrity>
<script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script>
</head>
<body class=td-page>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo></span><span class="text-uppercase font-weight-bold">Australian Imaging Service</span>
</a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link active" href=/docs/ target=_blank><span class=active>Dev Documentation</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/user_docs/ target=_blank><span>User Documentation</span></a>
</li>
</ul>
</div>
<div class="navbar-nav d-none d-lg-block">
<input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.5243fc487276ef8e412207bcd4f08274.json data-offline-search-base-href=/ data-offline-search-max-results=10>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
<div id=td-sidebar-menu class=td-sidebar__inner>
<form class="td-sidebar__search d-flex align-items-center">
<input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.5243fc487276ef8e412207bcd4f08274.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation">
</button>
</form>
<nav class="collapse td-sidebar-nav" id=td-section-nav>
<ul class="td-sidebar-nav__section pr-md-3 ul-0">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li>
<a href=/docs/ title=Documentation class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-docs><span>Dev Documentation</span></a>
<ul class=ul-1>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsinstruments-li>
<a href=/docs/instruments/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsinstruments><span>Instruments</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsinstrumentsrc-milabsu-ct-li>
<a href=/docs/instruments/rc-milabsu-ct/ title="RC MILabsU-CT" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsinstrumentsrc-milabsu-ct><span>MILabs U-CT</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsinstruments3t-and-7t-mri-li>
<a href=/docs/instruments/3t-and-7t-mri/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsinstruments3t-and-7t-mri><span>MR Solutions 3T & 7T MRI</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsinstrumentssiemens-artis-pheno-li>
<a href=/docs/instruments/siemens-artis-pheno/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsinstrumentssiemens-artis-pheno><span>Siemens ARTIS pheno</span></a>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsrepositories-li>
<a href=/docs/repositories/ title="Top level overview of the AIS repositories" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsrepositories><span>Repositories</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsdeployment-li>
<a href=/docs/deployment/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsdeployment><span>Deployment</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdeploymentalb-ingress-controller-li>
<a href=/docs/deployment/alb-ingress-controller/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdeploymentalb-ingress-controller><span>ALB Ingress Controller</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdeploymentazure-setup-full-li>
<a href=/docs/deployment/azure-setup-full/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdeploymentazure-setup-full><span>Azure Setup Full</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdeploymentlinode-setup-li>
<a href=/docs/deployment/linode-setup/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdeploymentlinode-setup><span></span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdeploymentreadme-li>
<a href=/docs/deployment/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdeploymentreadme><span></span></a>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsdevelopment-li>
<a href=/docs/development/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsdevelopment><span>Development</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdevelopmentcicd-li>
<a href=/docs/development/cicd/ title="Continuous Integration / Continuous Delivery" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdevelopmentcicd><span>CI/CD</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdevelopmentmacos-multipass-k8s-li>
<a href=/docs/development/macos-multipass-k8s/ title="Development workstation with Multipass on MacOS" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdevelopmentmacos-multipass-k8s><span>MacOS+Multipass</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdevelopmentubuntu-microk8s-li>
<a href=/docs/development/ubuntu-microk8s/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdevelopmentubuntu-microk8s><span>microk8s-Ubuntu</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdevelopmentnixos-minikube-li>
<a href=/docs/development/nixos-minikube/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdevelopmentnixos-minikube><span>NixOS + Minikube</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdevelopmentreferences-li>
<a href=/docs/development/references/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdevelopmentreferences><span>References</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdevelopmentwindows10-multipass-k8s-li>
<a href=/docs/development/windows10-multipass-k8s/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdevelopmentwindows10-multipass-k8s><span>Windows 10+Multipass</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdevelopmentxnat-chart-readme-li>
<a href=/docs/development/xnat-chart-readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdevelopmentxnat-chart-readme><span>XNAT chart README</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdevelopmentreadme-li>
<a href=/docs/development/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdevelopmentreadme><span></span></a>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docsoperations-li>
<a href=/docs/operations/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsoperations><span>Operations</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsoperationsaaf-integration-li>
<a href=/docs/operations/aaf-integration/ title="Integrating AAF with AIS Kubernetes XNAT Deployment" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsoperationsaaf-integration><span>AAF Integration</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsoperationsautoscaling-xnat-kubernetes-with-eks-li>
<a href=/docs/operations/autoscaling-xnat-kubernetes-with-eks/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsoperationsautoscaling-xnat-kubernetes-with-eks><span>Autoscaling XNAT on Kubernetes with EKS</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-docsoperationsdocker-swarm-with-xnat-li>
<a href=/docs/operations/docker-swarm-with-xnat/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-docsoperationsdocker-swarm-with-xnat><span class=td-sidebar-nav-active-item>Docker-Swarm-with-XNAT</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsoperationsexternal-pgsql-db-connection-li>
<a href=/docs/operations/external-pgsql-db-connection/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsoperationsexternal-pgsql-db-connection><span>External-PGSQL-DB-Connection</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsoperationsrecommendations-li>
<a href=/docs/operations/recommendations/ title="Operational recommendations" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsoperationsrecommendations><span>Recommendations</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsoperationsreadme-li>
<a href=/docs/operations/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsoperationsreadme><span></span></a>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docscontributing-li>
<a href=/docs/contributing/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscontributing><span>Contributing</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docscontributingdocumentation-li>
<a href=/docs/contributing/documentation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscontributingdocumentation><span>Documentation</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontributingdocumentationshortcodes-li>
<a href=/docs/contributing/documentation/shortcodes/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributingdocumentationshortcodes><span>Shortcodes</span></a>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontributingnew-repo-li>
<a href=/docs/contributing/new-repo/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributingnew-repo><span>Integrating a new repository</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontributingreadme-li>
<a href=/docs/contributing/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributingreadme><span></span></a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</aside>
<aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
<a href=https://github.com/Australian-Imaging-Service/charts/edit/main/docs/Operations/Docker-Swarm-with-XNAT.md target=_blank><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/Australian-Imaging-Service/charts/new/main/docs/Operations/Docker-Swarm-with-XNAT.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href="https://github.com/Australian-Imaging-Service/charts/issues/new?title=Docker-Swarm-with-XNAT" target=_blank><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
</div>
<div class=td-toc><nav id=TableOfContents>
<ul>
<li><a href=#pipelines>Pipelines</a></li>
<li><a href=#prerequisites>Prerequisites</a>
<ul>
<li><a href=#setup-dns-and-external-certificates>Setup DNS and external certificates</a></li>
<li><a href=#allow-remote-access-to-docker-api-endpoint-on-tcp-2376>Allow remote access to Docker API endpoint on TCP 2376</a></li>
<li><a href=#secure-access-to-tcp-port-2376>Secure access to TCP port 2376</a></li>
<li><a href=#ensure-docker-swarm-nodes-have-access-to-the-xnat-shared-filesystem>Ensure Docker Swarm nodes have access to the XNAT shared filesystem</a></li>
</ul>
</li>
<li><a href=#add-your-docker-swarm-to-xnat-plugin-settings>Add your Docker Swarm to XNAT Plugin Settings</a></li>
<li><a href=#troubleshooting>Troubleshooting</a></li>
</ul>
</nav></div>
</aside>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<nav aria-label=breadcrumb class="d-none d-md-block d-print-none">
<ol class="breadcrumb spb-1">
<li class=breadcrumb-item>
<a href=https://australian-imaging-service.github.io/docs/>Dev Documentation</a>
</li>
<li class=breadcrumb-item>
<a href=https://australian-imaging-service.github.io/docs/operations/>Operations</a>
</li>
<li class="breadcrumb-item active" aria-current=page>
<a href=https://australian-imaging-service.github.io/docs/operations/docker-swarm-with-xnat/>Docker-Swarm-with-XNAT</a>
</li>
</ol>
</nav>
<div class=td-content>
<h1>Docker-Swarm-with-XNAT</h1>
<header class=article-meta>
</header>
<h1 id=setting-up-docker-swarm>Setting up Docker Swarm</h1>
<p>A complete explanation of how to setup Docker Swarm is outside the scope of this document but you can find some useful articles here:<br>
<a href=https://scalified.com/2018/10/08/building-jenkins-pipelines-docker-swarm/>https://scalified.com/2018/10/08/building-jenkins-pipelines-docker-swarm/</a><br>
<a href=https://docs.docker.com/engine/swarm/swarm-tutorial/create-swarm/>https://docs.docker.com/engine/swarm/swarm-tutorial/create-swarm/</a><br>
<a href=https://docs.docker.com/engine/swarm/ingress/>https://docs.docker.com/engine/swarm/ingress/</a></p>
<p>Setting up with AWS:<br>
<a href=https://semaphoreci.com/community/tutorials/bootstrapping-a-docker-swarm-mode-cluster>https://semaphoreci.com/community/tutorials/bootstrapping-a-docker-swarm-mode-cluster</a></p>
<h2 id=pipelines>Pipelines</h2>
<p>XNAT uses pipelines to perform various different processes - mostly converting image types to other image types (DICOM to NIFTI for example).<br>
In the past this was handled on the instance as part of the XNAT program, then as a docker server on the instance and finally, externally as an external docker server, either directly or using Docker swarm.<br>
XNAT utilises the Container service which is a plugin to perform docker based pipelines. In the case of Kubernetes, docker MUST be run externally so Docker swarm is used as it provides load balancing.<br>
Whilst the XNAT team work on replacing the Container service on Docker Swarm with a Kubernetes based Container service, Docker swarm is the most appropriate stop gap option.</p>
<h2 id=prerequisites>Prerequisites</h2>
<p>You will require the Docker API endpoint opened remotely so that XNAT can access and send pipeline jobs to it. For security, this should be done via HTTPS (not HTTP).<br>
Standard port is TCP 2376. With Docker Swarm enabled you can send jobs to any of the manager or worker nodes and it will automatically internally load balance. I chose to use the Manager node&rsquo;s IP and pointed DNS to it.<br>
You should lock access to port 2376 to the Kubernetes XNAT subnets only using firewalls or Security Group settings. You can also use an external Load balancer with certificates which maybe preferred.<br>
If the certificates are not provided by a known CA, you will need to add the certificates (server, CA and client) to your XNAT container build so choosing a proper certificate from a known CA will make your life easier.<br>
If you do use self signed certificates, you will need create a folder, add the certificates and then specify that folder in the XNAT GUI > Administer > Plugin Settings > Container Server Setup > Edit Host Name. In our example case:</p>
<pre tabindex=0><code>Certificate Path: /usr/local/tomcat/certs
</code></pre><p>Access from the Docker Swarm to the XNAT shared filesystem - at a minimum Archive and build. The AIS Helm chart doesn&rsquo;t have /data/xnat/build setup by default but without this Docker Swarm can&rsquo;t write the temporaray files it needs and fails.</p>
<h3 id=setup-dns-and-external-certificates>Setup DNS and external certificates</h3>
<p>Whether you will need to create self signed certificates or public CA verified ones, you will need a fully qualified domain name to create them against.<br>
I suggest you set an A record to point to the Manager node IP address, or a Load Balancer which points to all nodes. Then create the certificates against your FQDN - e.g. swarm.example.com.</p>
<h3 id=allow-remote-access-to-docker-api-endpoint-on-tcp-2376>Allow remote access to Docker API endpoint on TCP 2376</h3>
<p>To enable docker to listen on port 2376 edit the service file or create /etc/docker/daemon.json.</p>
<p>We will edit the docker service file. Remember to specify whatever certificates you will be using in here. They will be pointing to your FQDN - in our case above, swarm.example.com.</p>
<pre tabindex=0><code>systemctl edit docker
</code></pre><pre tabindex=0><code>[Service]
ExecStart=
ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2376 --tlsverify --tlscacert /root/.docker/ca.pem --tlscert /root/.docker/server-cert.pem -tlskey /root/.docker/server-key.pem -H unix:///var/run/docker.sock
</code></pre><pre tabindex=0><code>systemctl restart docker
</code></pre><p>Repeat on all nodes. Docker Swarm is now listening remotely on TCP 2376.</p>
<h3 id=secure-access-to-tcp-port-2376>Secure access to TCP port 2376</h3>
<p>Add a firewall rule to only allow access to TCP port 2376 from the Kubernetes subnets.</p>
<h3 id=ensure-docker-swarm-nodes-have-access-to-the-xnat-shared-filesystem>Ensure Docker Swarm nodes have access to the XNAT shared filesystem</h3>
<p>Without access to the Archive shared filesystem Docker cannot run any pipeline conversions. This seems pretty obvious. Less obvious however is that the XNAT Docker Swarm requires access to the Build shared filesystem to run temporary jobs before writing back to Archive upon completion.<br>
This presents a problem as the AIS Helm Chart does not come with a persistent volume for the Build directory, so we need to create one.<br>
Create a volume outside the Helm Chart and then present it in your values file. In this example I created a custom class. Make sure accessMode is ReadWriteMany so Docker Swarm nodes can access.</p>
<pre tabindex=0><code>  volumes:
    build:
      accessMode: ReadWriteMany
      mountPath: /data/xnat/build
      storageClassName: &quot;custom-class&quot;
      volumeMode: Filesystem
      persistentVolumeReclaimPolicy: Retain
      persistentVolumeClaim:
        claimName: &quot;build-xnat-xnat-web&quot;
      size: 10Gi
</code></pre><p>You would need to create the custom-class storageclass and apply it first or the volume won&rsquo;t be created. In this case, create a file - storageclass.yaml and add the followinng contents:</p>
<pre tabindex=0><code>apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: custom-class
provisioner: kubernetes.io/no-provisioner
volumeBindingMode: WaitForFirstConsumer
</code></pre><p>You can then apply it:</p>
<pre tabindex=0><code>kubectl apply -f storageclass.yaml
</code></pre><p>Of course you may want to use an existing Storage Class so this maybe unnecessary, it is just an example.</p>
<p>Apply the Kubernetes volume file first and then apply the Helm chart and values file. You should now see something like the following:</p>
<pre tabindex=0><code>kubectl get -nxnat pvc,pv
NAME                                             STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/archive-xnat-xnat-web      Bound    archive-xnat-xnat-web                      10Gi       RWX            custom-class   5d1h
persistentvolumeclaim/build-xnat-xnat-web        Bound    build-xnat-xnat-web                        10Gi       RWX            custom-class   5d1h
persistentvolumeclaim/cache-xnat-xnat-web-0      Bound    pvc-b5b72b92-d15f-4a22-9b88-850bd726d1e2   10Gi       RWO            gp2            5d1h
persistentvolumeclaim/prearchive-xnat-xnat-web   Bound    prearchive-xnat-xnat-web                   10Gi       RWX            custom-class   5d1h

NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                           STORAGECLASS   REASON   AGE
persistentvolume/archive-xnat-xnat-web                      10Gi       RWX            Retain           Bound    xnat/archive-xnat-xnat-web      custom-class            5d1h
persistentvolume/build-xnat-xnat-web                        10Gi       RWX            Retain           Bound    xnat/build-xnat-xnat-web        custom-class            5d1h
persistentvolume/prearchive-xnat-xnat-web                   10Gi       RWX            Retain           Bound    xnat/prearchive-xnat-xnat-web   custom-class            5d1h
persistentvolume/pvc-b5b72b92-d15f-4a22-9b88-850bd726d1e2   10Gi       RWO            Delete           Bound    xnat/cache-xnat-xnat-web-0      gp2                     5d1h
</code></pre><p>As you can see, the build directory is now a mounted volume. You are now ready to mount the volumes on the Docker swarm nodes.</p>
<p>Depending how you presented your shared filesystem, just create the directories on the Docker swarm nodes and manager (if the manager is also a worker), add to /etc/fstab and mount the volumes.<br>
To make your life easier use the same file structure for the mounts - i.e build volume mounted in /data/xnat/build and archive volume mounted in /data/xnat/archive. If you don&rsquo;t do this you will need to specify the Docker swarm mounted XNAT directories in the XNAT GUI.</p>
<h2 id=add-your-docker-swarm-to-xnat-plugin-settings>Add your Docker Swarm to XNAT Plugin Settings</h2>
<p>You can read about the various options in the official XNAT documentation on their website here:<br>
<a href=https://wiki.xnat.org/container-service/installing-and-enabling-the-container-service-in-xnat-126156821.html>https://wiki.xnat.org/container-service/installing-and-enabling-the-container-service-in-xnat-126156821.html</a><br>
<a href=https://wiki.xnat.org/container-service/configuring-a-container-host-126156926.html>https://wiki.xnat.org/container-service/configuring-a-container-host-126156926.html</a></p>
<p>In the XNAT GUI, go to Administer > Plugin Settings > Container Server Setup and under Docker Server setup select > New Container host.<br>
In our above example, for host name you would select swarm.example.com, URL would be <a href=https://swarm.example.com:2376>https://swarm.example.com:2376</a> and certificate path would be /usr/local/tomcat/certs. As previously mentioned, it is desirable to have public CA and certificates to avoid the needs for specifying certificates at all here.<br>
Select Swarm Mode to &ldquo;ON&rdquo;.</p>
<p>You will need to select Path Translation if you DIDN&rsquo;T mount the Docker swarm XNAT directories in the same place.<br>
The other options are optional.</p>
<p>Once applied make sure that Status is &ldquo;Up&rdquo;.
The Image hosts section should also now have a status of Up.</p>
<p>You can now start adding your Images & Commands in the Administer > Plugin Settings > Images & Commands section.</p>
<h2 id=troubleshooting>Troubleshooting</h2>
<p>If you have configured docker swarm to listen on port 2376 but status says down, firstly check you can telnet or netcat to the port first locally, then remotely. From one of the nodes:</p>
<pre tabindex=0><code>nc -zv 127.0.0.1 2376
</code></pre><p>or</p>
<pre tabindex=0><code>telnet 127.0.0.1 2376
</code></pre><p>If you can, try remotely from a location that has firewall ingress access. In our example previously, try:</p>
<pre tabindex=0><code>nc -zv swarm.example.com 2376
telnet swarm.example.com 2376
</code></pre><p>Make sure the correct ports are open and accessible on the Docker swarm manager:</p>
<p>The network ports required for a Docker Swarm to function correctly are:<br>
TCP port 2376 for secure Docker client communication. This port is required for Docker Machine to work. Docker Machine is used to orchestrate Docker hosts.<br>
TCP port 2377. This port is used for communication between the nodes of a Docker Swarm or cluster. It only needs to be opened on manager nodes.<br>
TCP and UDP port 7946 for communication among nodes (container network discovery).<br>
UDP port 4789 for overlay network traffic (container ingress networking).</p>
<p>Make sure docker service is started on all docker swarm nodes.</p>
<p>If Status is set to Up and the container automations are failing, confirm the archive AND build shared filesystems are properly mounted on all servers - XNAT and Docker swarm. A Failed (Rejected) status for a pipeline is likely due to this error.</p>
<p>In this case, as a service can&rsquo;t be created you won&rsquo;t have enough time to see the service logs with the usual:</p>
<pre tabindex=0><code>docker service ls
</code></pre><p>command followed by looking at the service in question, so stop the docker service on the Docker swarm node and start in the foreground, using our service example above:</p>
<pre tabindex=0><code>dockerd -H tcp://0.0.0.0:2376 --tlsverify --tlscacert /root/.docker/ca.pem --tlscert /root/.docker/server-cert.pem --tlskey /root/.docker/server-key.pem -H unix:///var/run/docker.sock
</code></pre><p>Then upload some dicoms and watch the processing run in the foreground.</p>
<p>Docker Swarm admin guide:</p>
<p><a href=https://docs.docker.com/engine/swarm/admin_guide/>https://docs.docker.com/engine/swarm/admin_guide/</a></p>
<div class="text-muted mt-5 pt-3 border-top">
</div>
</div>
</main>
</div>
</div>
</div>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script>
<script src=/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js integrity="sha256-OxcsE7YsK+qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin=anonymous></script>
</body>
</html>