<!doctype html><html lang=en class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.87.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>Integrating AAF with AIS Kubernetes XNAT Deployment | Australian Imaging Service</title>
<meta name=description content><meta property="og:title" content="Integrating AAF with AIS Kubernetes XNAT Deployment">
<meta property="og:description" content="Applying for AAF Integration ClientId and Secret AAF have several services they offer which authenticate users, for example, Rapid Connect. We are interested in the AAF OIDC RP service. Please contact AAF Support via email at support@aaf.net.au to apply for a ClientId and Secret.
They will ask you these questions:
 The service’s redirect URL - a redirect URL based on an actual URL rather than IP address and must use HTTPS.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://australian-imaging-service.github.io/docs/charts/operations/aaf-integration/"><meta property="article:section" content="docs">
<meta itemprop=name content="Integrating AAF with AIS Kubernetes XNAT Deployment">
<meta itemprop=description content="Applying for AAF Integration ClientId and Secret AAF have several services they offer which authenticate users, for example, Rapid Connect. We are interested in the AAF OIDC RP service. Please contact AAF Support via email at support@aaf.net.au to apply for a ClientId and Secret.
They will ask you these questions:
 The service’s redirect URL - a redirect URL based on an actual URL rather than IP address and must use HTTPS.">
<meta itemprop=wordCount content="1146">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="Integrating AAF with AIS Kubernetes XNAT Deployment">
<meta name=twitter:description content="Applying for AAF Integration ClientId and Secret AAF have several services they offer which authenticate users, for example, Rapid Connect. We are interested in the AAF OIDC RP service. Please contact AAF Support via email at support@aaf.net.au to apply for a ClientId and Secret.
They will ask you these questions:
 The service’s redirect URL - a redirect URL based on an actual URL rather than IP address and must use HTTPS.">
<link rel=preload href=/scss/main.min.5419b25d80b653329e5e4289f61e83c2e1a212a94f70b03b4bd27f4bfe56fdf3.css as=style>
<link href=/scss/main.min.5419b25d80b653329e5e4289f61e83c2e1a212a94f70b03b4bd27f4bfe56fdf3.css rel=stylesheet integrity>
<script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script>
</head>
<body class=td-page>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo></span><span class="text-uppercase font-weight-bold">Australian Imaging Service</span>
</a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link active" href=/docs/ target=_blank><span class=active>Documentation</span></a>
</li>
</ul>
</div>
<div class="navbar-nav d-none d-lg-block">
<input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.8fe7053caa950c1bf4a0c2b07d307366.json data-offline-search-base-href=/ data-offline-search-max-results=10>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
<div id=td-sidebar-menu class=td-sidebar__inner>
<form class="td-sidebar__search d-flex align-items-center">
<input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.8fe7053caa950c1bf4a0c2b07d307366.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation">
</button>
</form>
<nav class="collapse td-sidebar-nav" id=td-section-nav>
<ul class="td-sidebar-nav__section pr-md-3 ul-0">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li>
<a href=/docs/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-docs><span>Documentation</span></a>
<ul class=ul-1>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsgetting-started-li>
<a href=/docs/getting-started/ title="AIS User guides" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsgetting-started><span>User guides</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsrepositories-li>
<a href=/docs/repositories/ title="Top level overview of the AIS repositories" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsrepositories><span>Repositories</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docscharts-li>
<a href=/docs/charts/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscharts><span>Charts</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docschartsdeployment-li>
<a href=/docs/charts/deployment/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docschartsdeployment><span>Deployment</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdeploymentalb-ingress-controller-li>
<a href=/docs/charts/deployment/alb-ingress-controller/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdeploymentalb-ingress-controller><span>ALB Ingress Controller</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdeploymentazure-setup-full-li>
<a href=/docs/charts/deployment/azure-setup-full/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdeploymentazure-setup-full><span>Azure Setup Full</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdeploymentreadme-li>
<a href=/docs/charts/deployment/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdeploymentreadme><span></span></a>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docschartsdevelopment-li>
<a href=/docs/charts/development/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docschartsdevelopment><span>Development</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdevelopmentcicd-li>
<a href=/docs/charts/development/cicd/ title="Continuous Integration / Continuous Delivery" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdevelopmentcicd><span>CI/CD</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdevelopmentmacos-multipass-k8s-li>
<a href=/docs/charts/development/macos-multipass-k8s/ title="Development workstation with Multipass on MacOS" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdevelopmentmacos-multipass-k8s><span>MacOS+Multipass</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdevelopmentubuntu-microk8s-li>
<a href=/docs/charts/development/ubuntu-microk8s/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdevelopmentubuntu-microk8s><span>microk8s-Ubuntu</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdevelopmentnixos-minikube-li>
<a href=/docs/charts/development/nixos-minikube/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdevelopmentnixos-minikube><span>NixOS + Minikube</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdevelopmentreferences-li>
<a href=/docs/charts/development/references/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdevelopmentreferences><span>References</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdevelopmentwindows10-multipass-k8s-li>
<a href=/docs/charts/development/windows10-multipass-k8s/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdevelopmentwindows10-multipass-k8s><span>Windows 10+Multipass</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdevelopmentxnat-chart-readme-li>
<a href=/docs/charts/development/xnat-chart-readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdevelopmentxnat-chart-readme><span>XNAT chart README</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdevelopmentreadme-li>
<a href=/docs/charts/development/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdevelopmentreadme><span></span></a>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docschartsoperations-li>
<a href=/docs/charts/operations/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docschartsoperations><span>Operations</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-docschartsoperationsaaf-integration-li>
<a href=/docs/charts/operations/aaf-integration/ title="Integrating AAF with AIS Kubernetes XNAT Deployment" class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-docschartsoperationsaaf-integration><span class=td-sidebar-nav-active-item>AAF Integration</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsoperationsautoscaling-xnat-kubernetes-with-eks-li>
<a href=/docs/charts/operations/autoscaling-xnat-kubernetes-with-eks/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsoperationsautoscaling-xnat-kubernetes-with-eks><span>Autoscaling XNAT on Kubernetes with EKS</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsoperationsexternal-pgsql-db-connection-li>
<a href=/docs/charts/operations/external-pgsql-db-connection/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsoperationsexternal-pgsql-db-connection><span>External-PGSQL-DB-Connection</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsoperationsrecommendations-li>
<a href=/docs/charts/operations/recommendations/ title="Operational recommendations" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsoperationsrecommendations><span>Recommendations</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsoperationsreadme-li>
<a href=/docs/charts/operations/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsoperationsreadme><span></span></a>
</li>
</ul>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docscontributing-li>
<a href=/docs/contributing/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscontributing><span>Contributing</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docscontributingdocumentation-li>
<a href=/docs/contributing/documentation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscontributingdocumentation><span>Documentation</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontributingdocumentationshortcodes-li>
<a href=/docs/contributing/documentation/shortcodes/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributingdocumentationshortcodes><span>Shortcodes</span></a>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontributingnew-repo-li>
<a href=/docs/contributing/new-repo/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributingnew-repo><span>Integrating a new repository</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontributingreadme-li>
<a href=/docs/contributing/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributingreadme><span></span></a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</aside>
<aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
</div>
<div class=td-toc><nav id=TableOfContents>
<ul>
<li><a href=#applying-for-aaf-integration-clientid-and-secret>Applying for AAF Integration ClientId and Secret</a></li>
<li><a href=#installing-the-aaf-plugin-in-a-working-xnat-environment>Installing the AAF Plugin in a working XNAT environment</a></li>
<li><a href=#using-aaf-with-the-ais-kubernetes-chart-deployment>Using AAF with the AIS Kubernetes Chart Deployment</a></li>
<li><a href=#troubleshooting>Troubleshooting</a></li>
</ul>
</nav></div>
</aside>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<nav aria-label=breadcrumb class="d-none d-md-block d-print-none">
<ol class="breadcrumb spb-1">
<li class=breadcrumb-item>
<a href=https://australian-imaging-service.github.io/docs/>Documentation</a>
</li>
<li class=breadcrumb-item>
<a href=https://australian-imaging-service.github.io/docs/charts/>Charts</a>
</li>
<li class=breadcrumb-item>
<a href=https://australian-imaging-service.github.io/docs/charts/operations/>Operations</a>
</li>
<li class="breadcrumb-item active" aria-current=page>
<a href=https://australian-imaging-service.github.io/docs/charts/operations/aaf-integration/>AAF Integration</a>
</li>
</ol>
</nav>
<div class=td-content>
<h1>Integrating AAF with AIS Kubernetes XNAT Deployment</h1>
<header class=article-meta>
</header>
<h2 id=applying-for-aaf-integration-clientid-and-secret>Applying for AAF Integration ClientId and Secret</h2>
<p>AAF have several services they offer which authenticate users, for example, Rapid Connect.
We are interested in the AAF OIDC RP service.
Please contact AAF Support via email at <a href=mailto:support@aaf.net.au>support@aaf.net.au</a> to apply for a ClientId and Secret.</p>
<p>They will ask you these questions:</p>
<ol>
<li>The service’s redirect URL - a redirect URL based on an actual URL rather than IP address and must use HTTPS.</li>
<li>A descriptive name for the service.</li>
<li>The organisation name, which must be an AAF subscriber, of the service.</li>
<li>Indicate the service’s purpose - development/testing/production-ready.</li>
<li>Your Keybase account id to share the credentials securely.</li>
</ol>
<p>For 1. This is extremely important and based on two options in the <code>openid-provider.properties</code> file:</p>
<ul>
<li><code>siteUrl</code></li>
<li><code>preEstablishedRedirUri</code></li>
</ul>
<p>We will use this example below (this is the correct syntax):</p>
<div>
<pre class=filename>openid-provider.properties</pre>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#c4a000>siteUrl</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>https://xnat.example.com  </span>
<span style=color:#c4a000>preEstablishedRedirUri</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>/openid-login</span></code></pre></div>
</div>
<p>In this case, the answer to 1 should be <a href=https://xnat.example.com/openid-login>https://xnat.example.com/openid-login</a>
Submitting <a href=https://xnat.example.com>https://xnat.example.com</a> will lead to a non functional AAF setup.</p>
<ol start=2>
<li>Can be anything – preferably descriptive.</li>
<li>Exactly what it says. Mostly the university name depending on organisation</li>
<li>This is important as it will dictate the AAF Servers your service will authenticate against.</li>
</ol>
<p>If it is a testing or development environment, you will use the following details:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#c4a000>openid.aaf.accessTokenUri</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>https://central.test.aaf.edu.au/providers/op/token  </span>
<span style=color:#c4a000>openid.aaf.userAuthUri</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>https://central.test.aaf.edu.au/providers/op/authorize</span>
</code></pre></div><p>For production environments (notice no test in the URLs):</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#c4a000>openid.aaf.accessTokenUri</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>https://central.aaf.edu.au/providers/op/token  </span>
<span style=color:#c4a000>openid.aaf.userAuthUri</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>https://central.aaf.edu.au/providers/op/authorize</span>
</code></pre></div><p>For 5. Just go to <a href=https://keybase.io/>https://keybase.io/</a> and create an account to provide to AAF support so you can receive the ClientId and ClientSecret securely.</p>
<h2 id=installing-the-aaf-plugin-in-a-working-xnat-environment>Installing the AAF Plugin in a working XNAT environment</h2>
<p>There have been long standing issues with the QCIF plugin that have been resolved by the AIS Deployment team – namely unable to access any projects – see image below.</p>
<p><img src=https://images.exxa.tech/xnat-aaf-error.png alt="Image of QCIF Openid plugin error"></p>
<p>This issue occurred regardless of project access permissions. You would receive this error message trying to access your own project!</p>
<p>AIS Deployment team created a forked version of the plugin which fixes this issue. You can view it here:</p>
<p><a href=https://github.com/Australian-Imaging-Service/xnat-openid-auth-plugin>https://github.com/Australian-Imaging-Service/xnat-openid-auth-plugin</a></p>
<p>To deploy to XNAT, navigate to the XNAT home/ plugins folder on your XNAT Application Server – normally /data/xnat/home/plugins and then download. Assuming Linux:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>wget https://github.com/Australian-Imaging-Service/xnat-openid-auth-plugin/releases/download/1.0.2/xnat-openid-auth-plugin-all-1.0.2.jar
</code></pre></div>
<div class="alert alert-primary" role=alert>
<p>Please note this was the latest version at the time of writing this document. Please check here to see if there have been updated versions:</p>
<p><a href=https://github.com/Australian-Imaging-Service/xnat-openid-auth-plugin/releases>https://github.com/Australian-Imaging-Service/xnat-openid-auth-plugin/releases</a></p>
</div>
<p>You now have <code>xnat-openid-auth-plugin-all-1.0.2.jar</code> in /data/xnat/home/plugins.<br>
You now need the configuration file which will be (assuming previous location for XNAT Home directory):</p>
<p><code>/data/xnat/home/config/auth/openid-provider.properties</code></p>
<p>You will need to create this file.</p>
<p>Review this sample file and tailor to your needs:</p>
<p><a href=https://github.com/Australian-Imaging-Service/xnat-openid-auth-plugin/blob/master/src/main/resources/openid-provider-sample-AAF.properties>https://github.com/Australian-Imaging-Service/xnat-openid-auth-plugin/blob/master/src/main/resources/openid-provider-sample-AAF.properties</a></p>
<p>I will provide an example filled out properties file with some caveats below.</p>
<div class="alert alert-warning" role=alert>
<h4 class=alert-heading>Warning</h4>
All of the keys are case sensitive, incorrectly capitalised entries will result in non-working AAF integration!
</div>
<p>These need to be left as is</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#c4a000>auth.method</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>openid  </span>
<span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>openid  </span>
<span style=color:#c4a000>provider.id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>openid  </span>
<span style=color:#c4a000>visible</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>true  </span>
</code></pre></div><p>Set these values to false if you want an Admin to enable and verify the account before users are allowed to login - recommended</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#c4a000>auto.enabled</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>false  </span>
<span style=color:#c4a000>auto.verified</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>false</span>
</code></pre></div><p>Name displayed in the UI – not particularly important</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>OpenID Authentication Provider</span>
</code></pre></div><p>Toggle username & password login visibility</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#c4a000>disableUsernamePasswordLogin</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>false</span>
</code></pre></div><p>List of providers that appear on the login page, see options below. In our case we only need aaf but you can have any openid enabled provider</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#c4a000>enabled</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>aaf</span>
</code></pre></div><p>Site URL - the main domain, needed to build the pre-established URL below. See notes at top of document</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#c4a000>siteUrl</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>https://xnat.example.com  </span>
<span style=color:#c4a000>preEstablishedRedirUri</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>/openid-login</span>
</code></pre></div><p>AAF ClientID and Secret – CASE SENSITIVE - openid.aaf.clientID for example would mean AAF plugin will not function
These are fake details but an example – no “ (quotation marks) required.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#c4a000>openid.aaf.clientId</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>123jsdjd  </span>
<span style=color:#c4a000>openid.aaf.clientSecret</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>chahdkdfdhffkhf</span>
</code></pre></div><p>The providers are covered at the top of the document</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#c4a000>openid.aaf.accessTokenUri</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>https://central.test.aaf.edu.au/providers/op/token  </span>
<span style=color:#c4a000>openid.aaf.userAuthUri</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>https://central.test.aaf.edu.au/providers/op/authorize</span>
</code></pre></div><p>You can find more details on the remaining values here:<br>
<a href=https://github.com/Australian-Imaging-Service/xnat-openid-auth-plugin>https://github.com/Australian-Imaging-Service/xnat-openid-auth-plugin</a></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#c4a000>openid.aaf.scopes</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>openid,profile,email</span>
</code></pre></div><p>If the below is wrong the AAF logo will not appear on the login page and you won’t be able to login</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#c4a000>openid.aaf.link</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&lt;p&gt;To sign-in using your AAF credentials, please click on the button below.&lt;/p&gt;&lt;p&gt;&lt;a href=&#34;/openid-login?providerId=aaf&#34;&gt;&lt;img src=&#34;/images/aaf_service_223x54.png&#34; /&gt;&lt;/a&gt;&lt;/p&gt;</span>
</code></pre></div><p>Flag that sets if we should be checking email domains</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#c4a000>openid.aaf.shouldFilterEmailDomains</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>false</span>
</code></pre></div><p>Domains below are allowed to login, only checked when <code>shouldFilterEmailDomains</code> is true</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#c4a000>openid.aaf.allowedEmailDomains</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>example.com  </span>
</code></pre></div><p>Flag to force the user creation process, normally this should be set to true</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#c4a000>openid.aaf.forceUserCreate</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>true</span>
</code></pre></div><p>Flag to set the enabled property of new users, set to false to allow admins to manually enable users before allowing logins, set to true to allow access right away</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#c4a000>openid.aaf.userAutoEnabled</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>false</span>
</code></pre></div><p>Flag to set the verified property of new users – use in conjunction with auto.verified</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#c4a000>openid.aaf.userAutoVerified</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>false</span>
</code></pre></div><p>Property names to use when creating users</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#c4a000>openid.aaf.emailProperty</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>email  </span>
<span style=color:#c4a000>openid.aaf.givenNameProperty</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>name  </span>
<span style=color:#c4a000>openid.aaf.familyNameProperty</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>deliberately_unknown_property  </span>
</code></pre></div><p>If you create your openid-provider.properties file with the above information, tailored to your environment, along with the plugin:<br>
<code>/data/xnat/home/plugins/xnat-openid-auth-plugin-all-1.0.2.jar</code></p>
<p>You should only need to restart Tomcat to enable login. This assumes you have a valid AAF organisation login.</p>
<h2 id=using-aaf-with-the-ais-kubernetes-chart-deployment>Using AAF with the AIS Kubernetes Chart Deployment</h2>
<p>The AIS Charts Helm template has all you need to setup a completely functional XNAT implementation in minutes, part of this is AAF integration.
Prerequisites:
• A functional HTTPS URL with valid SSL certificate for your Kubernetes cluster. See the top of this document for details to provide to AAF.<br>
• A ClientId and Secret provided by AAF.<br>
• A Load Balancer or way to connect externally to your Kubernetes using the functional URL with SSL certificate.</p>
<p>Before you deploy the Helm template, clone it via git here:<br>
git clone <a href=https://github.com/Australian-Imaging-Service/charts.git>https://github.com/Australian-Imaging-Service/charts.git</a></p>
<p>then edit the following file:<br>
<code>charts/releases/xnat/charts/xnat-web/values.yaml</code></p>
<p>And update the following entries underneath openid:</p>
<div class="alert alert-primary" role=alert>
NB> These entries DO require being placed within “”
</div>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>preEstablishedRedirUri</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/openid-login&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>siteUrl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#8f5902;font-style:italic>#List of providers that appear on the login page</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>providers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>aaf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>accessTokenUri</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://central.aaf.edu.au/providers/op/token</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic>#accessTokenUri: https://central.test.aaf.edu.au/providers/op/token</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>userAuthUri</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://central.aaf.edu.au/providers/op/authorize</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic>#userAuthUri: https://central.test.aaf.edu.au/providers/op/authorize</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>clientId</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>clientSecret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Comment out the Test or Production providers depending on which environment your XNAT will reside in. To use the example configuration from the previous configuration, the completed entries will look like this:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>preEstablishedRedirUri</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/openid-login&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>siteUrl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;https://xnat.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#8f5902;font-style:italic>#List of providers that appear on the login page</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>providers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>aaf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>accessTokenUri</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://central.test.aaf.edu.au/providers/op/token</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>userAuthUri</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://central.test.aaf.edu.au/providers/op/authorize</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>clientId</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;123jsdjd&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>clientSecret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;chahdkdfdhffkhf&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>You can now deploy your Helm template by following the README here:
<a href=https://github.com/Australian-Imaging-Service/charts>https://github.com/Australian-Imaging-Service/charts</a>
In order for this to work, you will need to point your domain name and SSL certificate to the Kubernetes xnat-web pod, which is outside of the scope of this document.</p>
<h2 id=troubleshooting>Troubleshooting</h2>
<p>Most of the above documentation should remove the need for troubleshooting but a few things to bear in mind.</p>
<ol>
<li>
<p>All of the openid-provider.properties file and the values.yaml file mentioned above for either existing XNAT deployments are CASE SENSITIVE. The entries must match exactly AAF won’t work.</p>
</li>
<li>
<p>If you get a 400 error message when redirecting from XNAT to AAF like so:</p>
<p><a href="https://central.test.aaf.edu.au/providers/op/authorize?client_id=&redirect_uri=https://xnat.example.com/openid-login&response_type=code&scope=openid%20profile%20email&state=IcoFrh">https://central.test.aaf.edu.au/providers/op/authorize?client_id=&redirect_uri=https://xnat.example.com/openid-login&response_type=code&scope=openid%20profile%20email&state=IcoFrh</a></p>
<p>The ClientId entry is wrong. This happened before when the properties file had ClientId like this:</p>
<pre><code>openid.aaf.clientID
</code></pre><p>rather than:</p>
<pre><code>openid.aaf.clientId
</code></pre><p>You can see client_id section is empty. This wrongly capitalised entry results in the clientId not be passed to the URL to redirect and a 400 error message.</p>
</li>
<li>
<p>Check the log files. The most useful log file for error messages is the Tomcat localhost logfile. On RHEL based systems, this can be found here (example logfile):</p>
<pre><code>/var/log/tomcat7/localhost.2021-08-08.log
</code></pre><p>You can also check the XNAT logfiles, mostly here (depending on where XNAT Home is on your system):</p>
<pre><code>/data/xnat/home/logs
</code></pre></li>
</ol>
<div class="text-muted mt-5 pt-3 border-top">
</div>
</div>
</main>
</div>
</div>
</div>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script>
<script src=/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js integrity="sha256-OxcsE7YsK+qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin=anonymous></script>
</body>
</html>