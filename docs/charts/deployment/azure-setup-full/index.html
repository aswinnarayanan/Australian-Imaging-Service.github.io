<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.85.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Azure Setup Full | Australian Imaging Service</title><meta name=description content><meta property="og:title" content="Azure Setup Full"><meta property="og:description" content="Create an AKS Cluster One of the great things about Azure is the Azure Cli. Specify Bash and then you can run all commands through your web browser and all tools and kubectl / az commands are already installed and available without having to create them on your workstation or spin up a VM instance for the sole purpose of controlling the cluster.
You can do this via the console if you want."><meta property="og:type" content="article"><meta property="og:url" content="/docs/charts/deployment/azure-setup-full/"><meta property="article:section" content="docs"><meta itemprop=name content="Azure Setup Full"><meta itemprop=description content="Create an AKS Cluster One of the great things about Azure is the Azure Cli. Specify Bash and then you can run all commands through your web browser and all tools and kubectl / az commands are already installed and available without having to create them on your workstation or spin up a VM instance for the sole purpose of controlling the cluster.
You can do this via the console if you want."><meta itemprop=wordCount content="1508"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Azure Setup Full"><meta name=twitter:description content="Create an AKS Cluster One of the great things about Azure is the Azure Cli. Specify Bash and then you can run all commands through your web browser and all tools and kubectl / az commands are already installed and available without having to create them on your workstation or spin up a VM instance for the sole purpose of controlling the cluster.
You can do this via the console if you want."><link rel=preload href=/scss/main.min.650bdee92aa16b3ae39822dd8dfd62356c714a590c397f4abe76572440c62901.css as=style><link href=/scss/main.min.650bdee92aa16b3ae39822dd8dfd62356c714a590c397f4abe76572440c62901.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo></span><span class="text-uppercase font-weight-bold">Australian Imaging Service</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/ target=_blank><span class=active>Documentation</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.05944c5654a46cbcf412be7ed448eff6.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.05944c5654a46cbcf412be7ed448eff6.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li><a href=/docs/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-docs><span>Documentation</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsgetting-started-li><a href=/docs/getting-started/ title="AIS User guides" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsgetting-started><span>User guides</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsrepositories-li><a href=/docs/repositories/ title="Top level overview of the AIS repositories" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsrepositories><span>Repositories</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docscharts-li><a href=/docs/charts/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscharts><span>Charts</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docschartsdeployment-li><a href=/docs/charts/deployment/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docschartsdeployment><span>Deployment</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdeploymentalb-ingress-controller-li><a href=/docs/charts/deployment/alb-ingress-controller/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdeploymentalb-ingress-controller><span>ALB Ingress Controller</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-docschartsdeploymentazure-setup-full-li><a href=/docs/charts/deployment/azure-setup-full/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-docschartsdeploymentazure-setup-full><span class=td-sidebar-nav-active-item>Azure Setup Full</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdeploymentreadme-li><a href=/docs/charts/deployment/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdeploymentreadme><span></span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docschartsdevelopment-li><a href=/docs/charts/development/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docschartsdevelopment><span>Development</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdevelopmentcicd-li><a href=/docs/charts/development/cicd/ title="Continuous Integration / Continuous Delivery" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdevelopmentcicd><span>CI/CD</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdevelopmentmacos-multipass-k8s-li><a href=/docs/charts/development/macos-multipass-k8s/ title="Development workstation with Multipass on MacOS" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdevelopmentmacos-multipass-k8s><span>MacOS+Multipass</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdevelopmentubuntu-microk8s-li><a href=/docs/charts/development/ubuntu-microk8s/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdevelopmentubuntu-microk8s><span>microk8s-Ubuntu</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdevelopmentnixos-minikube-li><a href=/docs/charts/development/nixos-minikube/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdevelopmentnixos-minikube><span>NixOS + Minikube</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdevelopmentreferences-li><a href=/docs/charts/development/references/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdevelopmentreferences><span>References</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdevelopmentwindows10-multipass-k8s-li><a href=/docs/charts/development/windows10-multipass-k8s/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdevelopmentwindows10-multipass-k8s><span>Windows 10+Multipass</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdevelopmentxnat-chart-readme-li><a href=/docs/charts/development/xnat-chart-readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdevelopmentxnat-chart-readme><span>XNAT chart README</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdevelopmentreadme-li><a href=/docs/charts/development/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdevelopmentreadme><span></span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docschartsoperations-li><a href=/docs/charts/operations/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docschartsoperations><span>Operations</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsoperationsaaf-integration-li><a href=/docs/charts/operations/aaf-integration/ title="Integrating AAF with AIS Kubernetes XNAT Deployment" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsoperationsaaf-integration><span>AAF Integration</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsoperationsautoscaling-xnat-kubernetes-with-eks-li><a href=/docs/charts/operations/autoscaling-xnat-kubernetes-with-eks/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsoperationsautoscaling-xnat-kubernetes-with-eks><span>Autoscaling XNAT on Kubernetes with EKS</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsoperationsexternal-pgsql-db-connection-li><a href=/docs/charts/operations/external-pgsql-db-connection/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsoperationsexternal-pgsql-db-connection><span>External-PGSQL-DB-Connection</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsoperationsrecommendations-li><a href=/docs/charts/operations/recommendations/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsoperationsrecommendations><span>Recommendations</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsoperationsreadme-li><a href=/docs/charts/operations/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsoperationsreadme><span></span></a></li></ul></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docscontributing-li><a href=/docs/contributing/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscontributing><span>Contributing</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontributingdocumentation-li><a href=/docs/contributing/documentation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributingdocumentation><span>Documentation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontributinggh-pages-li><a href=/docs/contributing/gh-pages/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributinggh-pages><span>GitHub Pages</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontributingnew-repo-li><a href=/docs/contributing/new-repo/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributingnew-repo><span>Integrating a new repository</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontributingreadme-li><a href=/docs/contributing/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributingreadme><span></span></a></li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#create-an-aks-cluster>Create an AKS Cluster</a><ul><li><a href=#download-and-install-ais-chart>Download and install AIS Chart</a></li><li><a href=#update-volume--persistence-information>Update volume / persistence information</a></li><li><a href=#create-a-kubernetes-secret>Create a Kubernetes Secret</a></li><li><a href=#create-kubernetes-volumes>Create Kubernetes Volumes</a></li></ul></li><li><a href=#update-our-override-values-file-for-our-helm-chart>Update our override values file for our Helm chart.</a><ul><li><a href=#creat-a-static-public-ip-an-ingress-controller-letsencrypt-certififcates-and-point-it-to-our-helm-chart>Creat a static public IP, an ingress controller, LetsEncrypt certififcates and point it to our Helm chart</a></li><li><a href=#install-cert-manager-and-attach-to-the-helm-chart-and-ingress-controller>Install Cert-Manager and attach to the Helm chart and Ingress Controller</a></li><li><a href=#update-your-override-values-file-to-point-to-your-ingress-controller-and-letsencrypt-cluster-issuer>Update your override values file to point to your ingress controller and Letsencrypt Cluster issuer</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=/docs/>Documentation</a></li><li class=breadcrumb-item><a href=/docs/charts/>Charts</a></li><li class=breadcrumb-item><a href=/docs/charts/deployment/>Deployment</a></li><li class="breadcrumb-item active" aria-current=page><a href=/docs/charts/deployment/azure-setup-full/>Azure Setup Full</a></li></ol></nav><div class=td-content><h1>Azure Setup Full</h1><header class=article-meta></header><h2 id=create-an-aks-cluster>Create an AKS Cluster</h2><p>One of the great things about Azure is the Azure Cli. Specify Bash and then you can run all commands through your web browser and all tools and kubectl / az commands are already installed and available without having to create them on your workstation or spin up a VM instance for the sole purpose of controlling the cluster.</p><p>You can do this via the console if you want. By Azure cli, see below. Create a resource group first.</p><p>Specify your Resource Group, cluster name (in our case xnat but please update if your Cluster is name differently), node count and VM instance size:</p><pre><code>az aks create \
--resource-group &lt;Resource Group Name&gt; \
--name xnat \
--node-count 3 \
--generate-ssh-keys \
--node-vm-size Standard_B2s \
--enable-managed-identity
</code></pre><p>Get AZ AKS credentials to run kubectl commands against your Cluster</p><pre><code>az aks get-credentials --name xnat --resource-group &lt;Resource Group Name&gt;
</code></pre><p>Confirm everything is setup correctly:</p><pre><code>kubectl get nodes -o wide
kubectl cluster-info
</code></pre><h3 id=download-and-install-ais-chart>Download and install AIS Chart</h3><pre><code>git clone https://github.com/Australian-Imaging-Service/charts.git
</code></pre><p>Add the AIS repo and update Helm:</p><pre><code>helm repo add ais https://australian-imaging-service.github.io/charts
helm repo update
</code></pre><p>Change to the correct directory and update dependencies. This will download and install the Postgresql Helm Chart. You don&rsquo;t need to do this if you want to connect to an external Postgresql DB.</p><pre><code>cd ~/charts/release/xnat
helm dependency update
</code></pre><p>Create the namespace and install the chart, then watch it be created.</p><pre><code>kubectl create namespace xnat
helm upgrade xnat ais/xnat --install -nxnat
watch kubectl -nxnat get all
</code></pre><p>It will complain that the Postgresql password is empty and needs updating.
Create an override values file (in this case values-aks.yaml but feel free to call it what you wish) and add the following inserting your own desired values:</p><pre><code>xnat-web:
  postgresql:
    postgresqlDatabase: &lt;your database&gt;
    postgresqlUsername: &lt;your username&gt;
    postgresqlPassword: &lt;your password&gt;
</code></pre><h3 id=update-volume--persistence-information>Update volume / persistence information</h3><p>It turns out that there is an issue with Storage classes that means that the volumes are not created automatically.
We need to make a small change to the storageClass configuration for the ReadWriteOnce volumes and create new external volumes for the ReadWriteMany ones.</p><p>Firstly, we create our own Azure files volumes for archive and prearchive and make a slight adjustment to the values configuration and apply as an override.</p><p>Follow this document for the details of how to do that:</p><p><a href=https://docs.microsoft.com/en-us/azure/aks/azure-files-volume>https://docs.microsoft.com/en-us/azure/aks/azure-files-volume</a></p><p>Firstly, export some values that will be used to create the Azure files volumes. Please substitute the details of your environment here.</p><pre><code>AKS_PERS_STORAGE_ACCOUNT_NAME=&lt;your storage account name&gt;
AKS_PERS_RESOURCE_GROUP=&lt;your resource group&gt;
AKS_PERS_LOCATION=&lt;your region&gt;
AKS_PERS_SHARE_NAME=archive-xnat-xnat-web
</code></pre><p><em><strong>archive-xnat-xnat-web</strong></em> will need to be used or the Helm chart won&rsquo;t be able to find the mount.</p><p>Create a storage account:</p><pre><code>az storage account create -n $AKS_PERS_STORAGE_ACCOUNT_NAME -g $AKS_PERS_RESOURCE_GROUP -l $AKS_PERS_LOCATION --sku Standard_LRS
</code></pre><p>Export the connection string as an environment variable, this is used when creating the Azure file share:</p><pre><code>export AZURE_STORAGE_CONNECTION_STRING=$(az storage account show-connection-string -n $AKS_PERS_STORAGE_ACCOUNT_NAME -g $AKS_PERS_RESOURCE_GROUP -o tsv)
</code></pre><p>Create the file share:</p><pre><code>az storage share create -n $AKS_PERS_SHARE_NAME --connection-string $AZURE_STORAGE_CONNECTION_STRING
</code></pre><p>Get storage account key:</p><pre><code>STORAGE_KEY=$(az storage account keys list --resource-group $AKS_PERS_RESOURCE_GROUP --account-name $AKS_PERS_STORAGE_ACCOUNT_NAME --query &quot;[0].value&quot; -o tsv)
</code></pre><p>Echo storage account name and key:</p><pre><code>echo Storage account name: $AKS_PERS_STORAGE_ACCOUNT_NAME
echo Storage account key: $STORAGE_KEY
</code></pre><p>Make a note of the Storage account name and key as you will need them.</p><p>Now repeat this process but update the Share name to prearchive-xnat-xnat-web. Run this first and then repeat the rest of the commands:</p><pre><code>AKS_PERS_SHARE_NAME=prearchive-xnat-xnat-web***
</code></pre><h3 id=create-a-kubernetes-secret>Create a Kubernetes Secret</h3><p>In order to mount the volumes, you need to create a secret. As we have created our Helm chart in the xnat namespace, we need to make sure that is added into the following command (not in the original Microsoft guide):</p><pre><code>kubectl -nxnat create secret generic azure-secret --from-literal=azurestorageaccountname=$AKS_PERS_STORAGE_ACCOUNT_NAME --from-literal=azurestorageaccountkey=$STORAGE_KEY
</code></pre><h3 id=create-kubernetes-volumes>Create Kubernetes Volumes</h3><p>Now we need to create two persistent volumes outside of the Helm Chart which the Chart can mount - hence requiring the exact name.<br>Create two files - <em><strong>pv_archive.yaml</strong></em> and <em><strong>pv_prearchive.yaml</strong></em></p><p>pv_archive.yaml:</p><pre><code>apiVersion: v1
kind: PersistentVolume
metadata:
  name: archive-xnat-xnat-web
spec:
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteMany
  claimRef:
    name: archive-xnat-xnat-web
    namespace: xnat
  azureFile:
    secretName: azure-secret
    shareName: archive-xnat-xnat-web
    readOnly: false
  mountOptions:
  - dir_mode=0755
  - file_mode=0755
  - uid=1000
  - gid=1000
  - mfsymlinks
  - nobrl
</code></pre><p>pv_prearchive.yaml:</p><pre><code>apiVersion: v1
kind: PersistentVolume
metadata:
  name: prearchive-xnat-xnat-web
spec:
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteMany
  claimRef:
    name: prearchive-xnat-xnat-web
    namespace: xnat
  azureFile:
    secretName: azure-secret
    shareName: prearchive-xnat-xnat-web
    readOnly: false
  mountOptions:
  - dir_mode=0755
  - file_mode=0755
  - uid=1000
  - gid=1000
  - mfsymlinks
  - nobrl
</code></pre><p>Size doesn&rsquo;t really matter as like EFS, Azure files is completely scaleable. Just make sure it is the same as your values file for those volumes.</p><h4 id=apply-the-volumes>Apply the volumes</h4><pre><code>kubectl apply -f pv_archive.yaml
kubectl apply -f pv_prearchive.yaml
</code></pre><p>We should now have two newly created volumes our Helm chart can mount.</p><h2 id=update-our-override-values-file-for-our-helm-chart>Update our override values file for our Helm chart.</h2><p>Edit your values-aks.yaml file from above and add the following in (postgresl entries already added):</p><p>Paste the following:</p><pre><code>xnat-web:
  persistence:
    cache:
      accessMode: ReadWriteOnce
      mountPath: /data/xnat/cache
      storageClassName: &quot;&quot;
      size: 10Gi
    work:
      accessMode: ReadWriteOnce
      mountPath: /data/xnat/home/work
      storageClassName: &quot;&quot;
      size: 1Gi
    logs:
      accessMode: ReadWriteOnce
      mountPath: /data/xnat/home/logs
      storageClassName: &quot;&quot;
      size: 1Gi
    plugins:
      accessMode: ReadWriteOnce
      mountPath: /data/xnat/home/plugins
      storageClassName: &quot;&quot;
      size: 0
  volumes:
    archive:
      accessMode: ReadWriteMany
      mountPath: /data/xnat/archive
      storageClassName: &quot;&quot;
      size: 10Gi
    prearchive:
      accessMode: ReadWriteMany
      mountPath: /data/xnat/prearchive
      storageClassName: &quot;&quot;
      size: 10Gi
  postgresql:
    postgresqlDatabase: &lt;your database&gt;
    postgresqlUsername: &lt;your username&gt;
    postgresqlPassword: &lt;your password&gt;
</code></pre><p>You can now apply the helm chart with your override and all the volumes will mount.</p><pre><code>helm upgrade xnat ais/xnat -i -f values-aks.yaml -nxnat
</code></pre><p>Congratulations! Your should now have a working XNAT environment with properly mounted volumes.</p><p>You can check everything is working:</p><pre><code>kubectl -nxnat get ev
kubectl -nxnat get all
kubectl -nxnat get pvc,pv
</code></pre><p>Check that the XNAT service comes up:</p><pre><code>kubectl -nxnat logs xnat-xnat-web-0 -f
</code></pre><h3 id=creat-a-static-public-ip-an-ingress-controller-letsencrypt-certififcates-and-point-it-to-our-helm-chart>Creat a static public IP, an ingress controller, LetsEncrypt certififcates and point it to our Helm chart</h3><p>OK so all good so far but we can&rsquo;t actually access our XNAT environment from outside of our cluster so we need to create an Ingress Controller.</p><p>You can follow the URL here from Microsoft for more detailed information:</p><p><a href=https://docs.microsoft.com/en-us/azure/aks/ingress-static-ip>https://docs.microsoft.com/en-us/azure/aks/ingress-static-ip</a></p><p>First, find out the resource name of the AKS Cluster:</p><pre><code>az aks show --resource-group &lt;your resource group&gt; --name &lt;your cluster name&gt; --query nodeResourceGroup -o tsv
</code></pre><p>This will create the output for your next command.</p><pre><code>az network public-ip create --resource-group &lt;output from previous command&gt; --name &lt;a name for your public IP&gt; --sku Standard --allocation-method static --query publicIp.ipAddress -o tsv
</code></pre><h4 id=point-your-fqdn-to-the-public-ip-address-you-created>Point your FQDN to the public IP address you created</h4><p>For the Letsencrypt certificate issuer to work it needs to be based on a working FQDN (fully qualified domain name), so in whatever DNS manager you use, create a new A record and point your xnat FQDN (xnat.example.com for example) to the IP address you just created.</p><p>Add the ingress-nginx repo:</p><pre><code>helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
</code></pre><p>Now create the ingress controller with a DNS Label (doesn&rsquo;t need to be FQDN here) and the IP created in the last command:</p><pre><code>helm install nginx-ingress ingress-nginx/ingress-nginx --namespace xnat --set controller.replicaCount=2 --set controller.nodeSelector.&quot;beta\.kubernetes\.io/os&quot;=linux --set defaultBackend.nodeSelector.&quot;beta\.kubernetes\.io/os&quot;=linux --set controller.admissionWebhooks.patch.nodeSelector.&quot;beta\.kubernetes\.io/os&quot;=linux --set controller.service.loadBalancerIP=&quot;1.2.3.4&quot; --set controller.service.annotations.&quot;service\.beta\.kubernetes\.io/azure-dns-label-name&quot;=&quot;xnat-aks&quot;
</code></pre><p>Please ensure to update the details above to suit your environment - including namespace.</p><h3 id=install-cert-manager-and-attach-to-the-helm-chart-and-ingress-controller>Install Cert-Manager and attach to the Helm chart and Ingress Controller</h3><pre><code>kubectl label namespace xnat cert-manager.io/disable-validation=true
helm repo add jetstack https://charts.jetstack.io
helm repo update
helm install   cert-manager   --namespace xnat   --version v1.3.1   --set installCRDs=true   --set nodeSelector.&quot;beta\.kubernetes\.io/os&quot;=linux   jetstack/cert-manager
</code></pre><p>You can find a write up of these commands and what they do in the Microsoft article.</p><h4 id=create-a-cluster-issueryaml-to-issue-the-letsencrypt-certificates>Create a cluster-issuer.yaml to issue the Letsencrypt certificates</h4><pre><code>apiVersion: cert-manager.io/v1alpha2
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: your@emailaddress.com
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
    - http01:
        ingress:
          class: nginx
          podTemplate:
            spec:
              nodeSelector:
                &quot;kubernetes.io/os&quot;: linux
</code></pre><p>In our case, we want production Letsencrypt certificates hence letsencrypt-prod (mentioned twice here and in values-aks.yaml). If you are doing testing you can use letsencrypt-staging. See Microsoft article for more details.<br>Please do not forget to use your email address here.</p><p>Apply the yaml file:</p><pre><code>kubectl apply -f cluster-issuer.yaml -nxnat
</code></pre><h3 id=update-your-override-values-file-to-point-to-your-ingress-controller-and-letsencrypt-cluster-issuer>Update your override values file to point to your ingress controller and Letsencrypt Cluster issuer</h3><p>Add the following to your values-aks.yaml file (I have added the volume and postgresql details as well for the complete values file):</p><pre><code>xnat-web:
  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: nginx
      cert-manager.io/cluster-issuer: letsencrypt-prod
    tls:
      - hosts:
          - &quot;yourxnat.example.com&quot;
        secretName: tls-secret
    hosts:
      - &quot;yourxnat.example.com&quot;
    rules:
      - host: &quot;yourxnat.example.com&quot;
        http:
          paths:
            - path: &quot;/&quot;
              backend:
                serviceName: &quot;xnat-xnat-web&quot;
                servicePort: 80
  persistence:
    cache:
      accessMode: ReadWriteOnce
      mountPath: /data/xnat/cache
      storageClassName: &quot;&quot;
      size: 10Gi
    work:
      accessMode: ReadWriteOnce
      mountPath: /data/xnat/home/work
      storageClassName: &quot;&quot;
      size: 1Gi
    logs:
      accessMode: ReadWriteOnce
      mountPath: /data/xnat/home/logs
      storageClassName: &quot;&quot;
      size: 1Gi
    plugins:
      accessMode: ReadWriteOnce
      mountPath: /data/xnat/home/plugins
      storageClassName: &quot;&quot;
      size: 0
  volumes:
    archive:
      accessMode: ReadWriteMany
      mountPath: /data/xnat/archive
      storageClassName: &quot;&quot;
      size: 10Gi
    prearchive:
      accessMode: ReadWriteMany
      mountPath: /data/xnat/prearchive
      storageClassName: &quot;&quot;
      size: 10Gi
  postgresql:
    postgresqlDatabase: &lt;your database&gt;
    postgresqlUsername: &lt;your username&gt;
    postgresqlPassword: &lt;your password&gt;
</code></pre><p>Change yourxnat.example.com to whatever you want your XNAT FQDN to be.<br>If you are using Letsencrypt-staging, update the cert-manager.io annotation accordingly.</p><p>Now update your helm chart and you should now have a fully working Azure XNAT installation with HTTPS redirection enabled, working volumes and fully automated certificates with automatic renewal.</p><pre><code>helm upgrade xnat ais/xnat -i -f values-aks.yaml -nxnat
</code></pre><div class="text-muted mt-5 pt-3 border-top"></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js integrity="sha256-OxcsE7YsK+qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin=anonymous></script></body></html>