<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.85.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>ALB Ingress Controller | Australian Imaging Service</title><meta name=description content><meta property="og:title" content="ALB Ingress Controller"><meta property="og:description" content="Creating an Application Load Balancer to connect to the AIS Helm chart XNAT Implementation We will be following this AWS Guide:
https://docs.aws.amazon.com/eks/latest/userguide/alb-ingress.html
Before we begin and incredibly important NB:
One thing that you need to know when we want to create new ALB from EKS is service spec type can only support LoadBalancer and NodePort. It won&rsquo;t support ClusterIP.
The Charts Repo has the service defined as ClusterIP so some changes need to be made to make this work."><meta property="og:type" content="article"><meta property="og:url" content="/docs/charts/deployment/alb-ingress-controller/"><meta property="article:section" content="docs"><meta itemprop=name content="ALB Ingress Controller"><meta itemprop=description content="Creating an Application Load Balancer to connect to the AIS Helm chart XNAT Implementation We will be following this AWS Guide:
https://docs.aws.amazon.com/eks/latest/userguide/alb-ingress.html
Before we begin and incredibly important NB:
One thing that you need to know when we want to create new ALB from EKS is service spec type can only support LoadBalancer and NodePort. It won&rsquo;t support ClusterIP.
The Charts Repo has the service defined as ClusterIP so some changes need to be made to make this work."><meta itemprop=wordCount content="1029"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="ALB Ingress Controller"><meta name=twitter:description content="Creating an Application Load Balancer to connect to the AIS Helm chart XNAT Implementation We will be following this AWS Guide:
https://docs.aws.amazon.com/eks/latest/userguide/alb-ingress.html
Before we begin and incredibly important NB:
One thing that you need to know when we want to create new ALB from EKS is service spec type can only support LoadBalancer and NodePort. It won&rsquo;t support ClusterIP.
The Charts Repo has the service defined as ClusterIP so some changes need to be made to make this work."><link rel=preload href=/scss/main.min.650bdee92aa16b3ae39822dd8dfd62356c714a590c397f4abe76572440c62901.css as=style><link href=/scss/main.min.650bdee92aa16b3ae39822dd8dfd62356c714a590c397f4abe76572440c62901.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo></span><span class="text-uppercase font-weight-bold">Australian Imaging Service</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/ target=_blank><span class=active>Documentation</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.05944c5654a46cbcf412be7ed448eff6.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.05944c5654a46cbcf412be7ed448eff6.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li><a href=/docs/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-docs><span>Documentation</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsgetting-started-li><a href=/docs/getting-started/ title="AIS User guides" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsgetting-started><span>User guides</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsrepositories-li><a href=/docs/repositories/ title="Top level overview of the AIS repositories" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsrepositories><span>Repositories</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docscharts-li><a href=/docs/charts/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscharts><span>Charts</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docschartsdeployment-li><a href=/docs/charts/deployment/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docschartsdeployment><span>Deployment</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-docschartsdeploymentalb-ingress-controller-li><a href=/docs/charts/deployment/alb-ingress-controller/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-docschartsdeploymentalb-ingress-controller><span class=td-sidebar-nav-active-item>ALB Ingress Controller</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdeploymentazure-setup-full-li><a href=/docs/charts/deployment/azure-setup-full/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdeploymentazure-setup-full><span>Azure Setup Full</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdeploymentreadme-li><a href=/docs/charts/deployment/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdeploymentreadme><span></span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docschartsdevelopment-li><a href=/docs/charts/development/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docschartsdevelopment><span>Development</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdevelopmentcicd-li><a href=/docs/charts/development/cicd/ title="Continuous Integration / Continuous Delivery" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdevelopmentcicd><span>CI/CD</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdevelopmentmacos-multipass-k8s-li><a href=/docs/charts/development/macos-multipass-k8s/ title="Development workstation with Multipass on MacOS" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdevelopmentmacos-multipass-k8s><span>MacOS+Multipass</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdevelopmentubuntu-microk8s-li><a href=/docs/charts/development/ubuntu-microk8s/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdevelopmentubuntu-microk8s><span>microk8s-Ubuntu</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdevelopmentnixos-minikube-li><a href=/docs/charts/development/nixos-minikube/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdevelopmentnixos-minikube><span>NixOS + Minikube</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdevelopmentreferences-li><a href=/docs/charts/development/references/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdevelopmentreferences><span>References</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdevelopmentwindows10-multipass-k8s-li><a href=/docs/charts/development/windows10-multipass-k8s/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdevelopmentwindows10-multipass-k8s><span>Windows 10+Multipass</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdevelopmentxnat-chart-readme-li><a href=/docs/charts/development/xnat-chart-readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdevelopmentxnat-chart-readme><span>XNAT chart README</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsdevelopmentreadme-li><a href=/docs/charts/development/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsdevelopmentreadme><span></span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docschartsoperations-li><a href=/docs/charts/operations/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docschartsoperations><span>Operations</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsoperationsaaf-integration-li><a href=/docs/charts/operations/aaf-integration/ title="Integrating AAF with AIS Kubernetes XNAT Deployment" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsoperationsaaf-integration><span>AAF Integration</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsoperationsautoscaling-xnat-kubernetes-with-eks-li><a href=/docs/charts/operations/autoscaling-xnat-kubernetes-with-eks/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsoperationsautoscaling-xnat-kubernetes-with-eks><span>Autoscaling XNAT on Kubernetes with EKS</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsoperationsexternal-pgsql-db-connection-li><a href=/docs/charts/operations/external-pgsql-db-connection/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsoperationsexternal-pgsql-db-connection><span>External-PGSQL-DB-Connection</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsoperationsrecommendations-li><a href=/docs/charts/operations/recommendations/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsoperationsrecommendations><span>Recommendations</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docschartsoperationsreadme-li><a href=/docs/charts/operations/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docschartsoperationsreadme><span></span></a></li></ul></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docscontributing-li><a href=/docs/contributing/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscontributing><span>Contributing</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontributingdocumentation-li><a href=/docs/contributing/documentation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributingdocumentation><span>Documentation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontributinggh-pages-li><a href=/docs/contributing/gh-pages/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributinggh-pages><span>GitHub Pages</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontributingnew-repo-li><a href=/docs/contributing/new-repo/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributingnew-repo><span>Integrating a new repository</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontributingreadme-li><a href=/docs/contributing/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributingreadme><span></span></a></li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#creating-an-application-load-balancer-to-connect-to-the-ais-helm-chart-xnat-implementation>Creating an Application Load Balancer to connect to the AIS Helm chart XNAT Implementation</a></li><li><a href=#add-ssl-encryption-to-your-application-load-balancer>Add SSL encryption to your Application Load Balancer</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=/docs/>Documentation</a></li><li class=breadcrumb-item><a href=/docs/charts/>Charts</a></li><li class=breadcrumb-item><a href=/docs/charts/deployment/>Deployment</a></li><li class="breadcrumb-item active" aria-current=page><a href=/docs/charts/deployment/alb-ingress-controller/>ALB Ingress Controller</a></li></ol></nav><div class=td-content><h1>ALB Ingress Controller</h1><header class=article-meta></header><h2 id=creating-an-application-load-balancer-to-connect-to-the-ais-helm-chart-xnat-implementation>Creating an Application Load Balancer to connect to the AIS Helm chart XNAT Implementation</h2><p>We will be following this AWS Guide:<br><a href=https://docs.aws.amazon.com/eks/latest/userguide/alb-ingress.html>https://docs.aws.amazon.com/eks/latest/userguide/alb-ingress.html</a></p><p>Before we begin and incredibly important NB:<br>One thing that you need to know when we want to create new ALB from EKS is service spec type can only support LoadBalancer and NodePort. It won&rsquo;t support ClusterIP.</p><p>The Charts Repo has the service defined as ClusterIP so some changes need to be made to make this work. We will get to that later after we have created the ALB and policies.</p><p>In this document we create a Cluster called xnat in ap-southeast-2. Please update these details for your environment.</p><p>Create an IAM OIDC provider and associate with cluster:</p><pre><code>eksctl utils associate-iam-oidc-provider --region ap-southeast-2 --cluster xnat --approve
</code></pre><p>Download the IAM Policy:</p><pre><code>curl -o iam-policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/main/docs/install/iam_policy.json
</code></pre><p>Create the IAM policy and take a note of the ARN:</p><pre><code>aws iam create-policy --policy-name AWSLoadBalancerControllerIAMPolicy --policy-document file://iam-policy.json
</code></pre><p>Create the service account using ARN from the previous command (substitute your ARN for the XXX):</p><pre><code>eksctl create iamserviceaccount --cluster=xnat --namespace=kube-system --name=aws-load-balancer-controller --attach-policy-arn=arn:aws:iam::XXXXXXXXX:policy/AWSLoadBalancerControllerIAMPolicy --override-existing-serviceaccounts --approve
</code></pre><p>Install TargetGroupBinding:</p><pre><code>kubectl apply -k &quot;github.com/aws/eks-charts/stable/aws-load-balancer-controller//crds?ref=master&quot;
</code></pre><p>Install the AWS Load Balancer Controller:</p><pre><code>helm upgrade -i aws-load-balancer-controller eks/aws-load-balancer-controller --set clusterName=xnat --set serviceAccount.create=false --set serviceAccount.name=aws-load-balancer-controller -n kube-system
</code></pre><p>Confirm it is installed:</p><pre><code>kubectl get deployment -n kube-system aws-load-balancer-controller
</code></pre><p>You should see - READY 1/1 if it is installed properly</p><p>In order to apply this to the XNAT Charts Helm template update the charts/xnat/values.yaml file to remove the Nginx ingress parts and add the ALB ingress parts.</p><p>Added to values file:</p><pre><code>      kubernetes.io/ingress.class: alb
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/group.name: xnat
      alb.ingress.kubernetes.io/target-type: ip
</code></pre><p>NB. Although you can specify ip or instance for the target-type, you need to specify ip or autoscaling won&rsquo;t function correctly. This is because stickiness isn&rsquo;t honoured for target-type instance so you have the known issue where XNAT database thinks you are logged in but instance / pod knows you are not and then it logs you out again.</p><p>For more ALB annotations / options, please see article at the bottom of the page.</p><p>Commented out / removed:</p><pre><code>      kubernetes.io/ingress.class: &quot;nginx&quot;
      kubernetes.io/tls-acme: &quot;true&quot;
      nginx.ingress.kubernetes.io/whitelist-source-range: &quot;130.95.0.0/16 127.0.0.0/8&quot;
      nginx.ingress.kubernetes.io/proxy-connect-timeout: &quot;150&quot;
      nginx.ingress.kubernetes.io/proxy-send-timeout: &quot;100&quot;
      nginx.ingress.kubernetes.io/proxy-read-timeout: &quot;100&quot;
      nginx.ingress.kubernetes.io/proxy-buffers-number: &quot;4&quot;
      nginx.ingress.kubernetes.io/proxy-buffer-size: &quot;32k&quot;
</code></pre><p>As pointed out ClusterIP as service type does not work with ALB. So you will have to make some further changes to charts/xnat/charts/xnat-web/values.yaml:</p><p>Change:</p><pre><code>service:
  type: ClusterIP
  port: 80
</code></pre><p>to:</p><pre><code>service:
  type: NodePort
  port: 80
</code></pre><p>In xnat/charts/xnat-web/templates/service.yaml remove the line:</p><pre><code>clusterIP: None
</code></pre><p>Then create the Helm chart with the usual command (after building dependencies - just follow README.md). If you are updating an existing xnat installation it will fail so you will need to create a new application.</p><pre><code>helm upgrade xnat . -nxnat
</code></pre><p>It should now create a Target Group and Application Load Balancer in AWS EC2 Services. I had to make a further change to get this to work.</p><p>On the Target Group I had to change health check code from 200 to 302 to get a healthy instance because it redirects.</p><p>You can fix this by adding the following line to values file:</p><pre><code>      # Specify Health Checks
      alb.ingress.kubernetes.io/healthcheck-path: &quot;/&quot;
      alb.ingress.kubernetes.io/success-codes: &quot;302&quot;
</code></pre><p>Troubleshooting and make sure ALB is created:</p><pre><code>watch kubectl -n kube-system get all
</code></pre><p>Find out controller name in pod. In this case - pod/aws-load-balancer-controller-98f66dcb8-zkz8k</p><p>Make sure all are up.</p><p>Check logs:</p><pre><code>kubectl logs -n kube-system aws-load-balancer-controller-98f66dcb8-zkz8k
</code></pre><p>When updating ALB is often doesn&rsquo;t update properly so you will need to delete and recreate the ALB:</p><pre><code>kubectl delete deployment -n kube-system aws-load-balancer-controller
helm upgrade -i aws-load-balancer-controller eks/aws-load-balancer-controller --set clusterName=xnat --set serviceAccount.create=false --set serviceAccount.name=aws-load-balancer-controller -n kube-system
</code></pre><p>Change the stickiness of the Load Balancer:<br>It is important to set a stickiness time on the load balancer or you can get an issue where the Database thinks you have logged in but the pod you connect to knows you haven’t so you can’t login. Setting stickiness reasonably high – say 30 minutes, can get round this.</p><pre><code>alb.ingress.kubernetes.io/target-group-attributes: stickiness.enabled=true,stickiness.lb_cookie.duration_seconds=1800
</code></pre><p>Change the Load Balancing Algorithm:</p><pre><code>alb.ingress.kubernetes.io/target-group-attributes: load_balancing.algorithm.type=least_outstanding_requests
</code></pre><h2 id=add-ssl-encryption-to-your-application-load-balancer>Add SSL encryption to your Application Load Balancer</h2><p>Firstly, you need to add an SSL certificate to your ALB annotations. Kubernetes has a built in module: Cert Manager, to deal with cross clouds / infrastructure.</p><p><a href=https://cert-manager.io/docs/installation/kubernetes/>https://cert-manager.io/docs/installation/kubernetes/</a></p><p>However, in this case, AWS has a built in Certificate Manager that creates and a renews SSL certificates for free so we will be using this technology.</p><p>You can read more about it here:</p><p><a href="https://aws.amazon.com/certificate-manager/getting-started/#:~:text=To%20get%20started%20with%20ACM,certificate%20from%20your%20Private%20CA">https://aws.amazon.com/certificate-manager/getting-started/#:~:text=To%20get%20started%20with%20ACM,certificate%20from%20your%20Private%20CA</a>.</p><p>This assumes you have a valid certificate created through AWS Certificate Manager and you know the ARN.</p><p>These are additional annotations to add to values file and explanations above:</p><p>Listen on port 80 and 443:<br><code>alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS":443}]'</code></p><p>Specify the ARN of your SSL certificate from AWS Certificate Manager (change for your actual ARN):<br><code>alb.ingress.kubernetes.io/certificate-arn: "arn:aws:acm:XXXXXXX:certificate/XXXXXX"</code></p><p>Specify AWS SSL Policy:<br><code>alb.ingress.kubernetes.io/ssl-policy: "ELBSecurityPolicy-TLS-1-2-Ext-2018-06"</code></p><p>For more details see here of SSL policy options:<br><a href=https://docs.aws.amazon.com/elasticloadbalancing/latest/application/create-https-listener.html>https://docs.aws.amazon.com/elasticloadbalancing/latest/application/create-https-listener.html</a></p><p>Finally, for this to successfully work you need to change the host path to allow any path or the Tomcat URL will be sent to a 404 by the Load Balancer. Put a wildcard in the paths to allow any eventual URL (starting with xnat.example.com in this case):</p><pre><code>    hosts:
      - host: xnat.example.com
        paths: [ &quot;/*&quot; ]
</code></pre><p>Redirect HTTP to HTTPS:
This does not work on Kubernetes 1.19 or above as the “use-annotation” command does not work. There is seemingly no documentation on the required annotations to make this work.</p><p>Add the following annotation to your values file below the ports to listen on (see above):</p><pre><code> alb.ingress.kubernetes.io/actions.ssl-redirect: '{&quot;Type&quot;: &quot;redirect&quot;, &quot;RedirectConfig&quot;: {&quot;Protocol&quot;: &quot;HTTPS&quot;, &quot;Port&quot;: &quot;443&quot;, &quot;StatusCode&quot;: &quot;HTTP_301&quot;}}'
</code></pre><p>You must then update the Rules section of ingress.yaml found within the releases/xnat/charts/xnat-web/templates directory to look like this:</p><pre><code>  rules:
    {{- range .Values.ingress.hosts }}
    - host: {{ .host | quote }}
      http:
        paths:
          {{- range .paths }}
          - path: {{ .path }}
            backend:
              serviceName: {{ $fullName }}
              servicePort: {{ $svcPort }}
          {{- end }}
    {{- end }}
  
</code></pre><p>This will redirect HTTP to HTTPS on Kubernetes 1.18 and below.</p><p>Full values.yaml file ingress section:</p><pre><code>  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: alb
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/target-type: ip
      alb.ingress.kubernetes.io/listen-ports: '[{&quot;HTTP&quot;: 80}, {&quot;HTTPS&quot;:443}]'
      alb.ingress.kubernetes.io/actions.ssl-redirect: '{&quot;Type&quot;: &quot;redirect&quot;, &quot;RedirectConfig&quot;: {&quot;Protocol&quot;: &quot;HTTPS&quot;, &quot;Port&quot;: &quot;443&quot;, &quot;StatusCode&quot;: &quot;HTTP_301&quot;}}'
      alb.ingress.kubernetes.io/healthcheck-path: &quot;/&quot;
      alb.ingress.kubernetes.io/success-codes: &quot;302&quot;
      alb.ingress.kubernetes.io/certificate-arn: &quot;arn:aws:acm:XXXXXXX:certificate/XXXXXX&quot;
      alb.ingress.kubernetes.io/ssl-policy: &quot;ELBSecurityPolicy-TLS-1-2-Ext-2018-06&quot;
      alb.ingress.kubernetes.io/target-group-attributes: &quot;stickiness.enabled=true,stickiness.lb_cookie.duration_seconds=1800,load_balancing.algorithm.type=least_outstanding_requests&quot;
</code></pre><p>Further Reading:<br><a href=https://medium.com/devops-dudes/running-the-latest-aws-load-balancer-controller-in-your-aws-eks-cluster-9d59cdc1db98>https://medium.com/devops-dudes/running-the-latest-aws-load-balancer-controller-in-your-aws-eks-cluster-9d59cdc1db98</a></p><p>Troubleshooting EKS Load Balancers:<br><a href=https://aws.amazon.com/premiumsupport/knowledge-center/eks-load-balancers-troubleshooting/>https://aws.amazon.com/premiumsupport/knowledge-center/eks-load-balancers-troubleshooting/</a>
<a href=https://medium.com/@ManagedKube/kubernetes-troubleshooting-ingress-and-services-traffic-flows-547ea867b120>https://medium.com/@ManagedKube/kubernetes-troubleshooting-ingress-and-services-traffic-flows-547ea867b120</a></p><p>ALB annotations:<br><a href=https://kubernetes-sigs.github.io/aws-load-balancer-controller/guide/ingress/annotations/>https://kubernetes-sigs.github.io/aws-load-balancer-controller/guide/ingress/annotations/</a></p><div class="text-muted mt-5 pt-3 border-top"></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js integrity="sha256-OxcsE7YsK+qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin=anonymous></script></body></html>